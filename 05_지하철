# ==========================================
# streamlit_subway_top10.py
# Streamlit ì•± (Streamlit Cloud ë°°í¬ìš©)
# ì„¤ëª…: ì—…ë¡œë“œí•œ CSV(í˜¹ì€ ê¸°ë³¸ ê²½ë¡œ)ë¥¼ ì½ì–´
# 2025ë…„ 10ì›” ì¤‘ ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œì™€ í˜¸ì„ ì˜
# ìŠ¹ì°¨+í•˜ì°¨ í•©ê³„ ê¸°ì¤€ TOP10 ì—­ì„ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
# í”Œë¡œí‹€ë¦¬ë¡œ ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ ìƒì„±, ìƒ‰ìƒ: 1ë“± ë˜¥ìƒ‰(ê°ˆìƒ‰), ë‚˜ë¨¸ì§€ëŠ” í•‘í¬ ê·¸ë¼ë°ì´ì…˜
# ==========================================

# -----------------
# requirements.txt
# -----------------
# streamlit==1.25.0
# pandas==2.2.2
# plotly==5.15.0
# (Streamlit Cloudì—ì„œëŠ” ìµœì‹  ë²„ì „ ì‚¬ìš© ê°€ëŠ¥ â€” ìœ„ ë²„ì „ì€ ê¶Œì¥ ì˜ˆì‹œ)

# ì‚¬ìš©ë²•:
# 1) ì´ íŒŒì¼ê³¼ requirements.txtë¥¼ ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— ì˜¬ë ¤ì„œ Streamlit Cloudì— ë°°í¬í•˜ê±°ë‚˜
# 2) ë¡œì»¬ì—ì„œ ì‹¤í–‰: `pip install -r requirements.txt` ì´í›„ `streamlit run streamlit_subway_top10.py`

# ---------------------------------
# ì‹¤ì œ Streamlit ì•± ì½”ë“œ ì‹œì‘
# ---------------------------------
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from datetime import date
from io import StringIO

st.set_page_config(page_title="ì§€í•˜ì²  TOP10 ì‹œê°í™”", layout='wide')

st.title("ğŸš‡ ì§€í•˜ì²  ì—­ë³„ ìƒìœ„ 10ê°œ ìŠ¹ê°ìˆ˜ (2025ë…„ 10ì›”)")
st.markdown("ì—…ë¡œë“œí•œ CSV ë˜ëŠ” ê¸°ë³¸ íŒŒì¼ì„ ì‚¬ìš©í•´ ë‚ ì§œì™€ í˜¸ì„ ì„ ì„ íƒí•˜ë©´ ìŠ¹ì°¨+í•˜ì°¨ í•©ê³„ ê¸°ì¤€ ìƒìœ„ 10ê°œ ì—­ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")

# --- íŒŒì¼ ì—…ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ íŒŒì¼ ì‚¬ìš© ---
uploaded = st.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ (ì¸ì½”ë”©: CP949 ê¶Œì¥)", type=['csv'])
use_default = False
if uploaded is None:
    st.info("íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´, ì„œë²„ì˜ ê¸°ë³¸ ê²½ë¡œ '/mnt/data/ë˜¥.csv' ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.")
    use_default = st.checkbox("ê¸°ë³¸ íŒŒì¼('/mnt/data/ë˜¥.csv') ì‚¬ìš©", value=True)

# ë°ì´í„° ë¡œë” í•¨ìˆ˜
@st.cache_data
def load_data(uploaded_file, use_default):
    if uploaded_file is not None:
        # pandasê°€ ìë™ìœ¼ë¡œ ë°”ì´ë„ˆë¦¬ ìŠ¤íŠ¸ë¦¼ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¸ì½”ë”© ë¬¸ì œëŠ” pandasì— ë§¡ê¹€
        try:
            df = pd.read_csv(uploaded_file, encoding='cp949')
        except Exception:
            # ì‹œë„: utf-8
            df = pd.read_csv(uploaded_file, encoding='utf-8')
    else:
        if use_default:
            path = '/mnt/data/ë˜¥.csv'
            df = pd.read_csv(path, encoding='cp949')
        else:
            return None

    # ì»¬ëŸ¼ ì •ë¦¬
    # ê¸°ëŒ€ ì»¬ëŸ¼: ì‚¬ìš©ì¼ì, ë…¸ì„ ëª…, ì—­ëª…, ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜, í•˜ì°¨ì´ìŠ¹ê°ìˆ˜
    expected = ['ì‚¬ìš©ì¼ì', 'ë…¸ì„ ëª…', 'ì—­ëª…', 'ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜', 'í•˜ì°¨ì´ìŠ¹ê°ìˆ˜']
    missing = [c for c in expected if c not in df.columns]
    if missing:
        raise ValueError(f"CSVì— ë‹¤ìŒ ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤: {missing}")

    # ë‚ ì§œ ë³€í™˜
    df['ì‚¬ìš©ì¼ì'] = df['ì‚¬ìš©ì¼ì'].astype(str)
    df['ì‚¬ìš©ì¼ì_dt'] = pd.to_datetime(df['ì‚¬ìš©ì¼ì'], format='%Y%m%d', errors='coerce')

    # ìŠ¹í•˜ì°¨ numeric ê°•ì œ
    df['ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜'] = pd.to_numeric(df['ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜'], errors='coerce').fillna(0).astype(int)
    df['í•˜ì°¨ì´ìŠ¹ê°ìˆ˜'] = pd.to_numeric(df['í•˜ì°¨ì´ìŠ¹ê°ìˆ˜'], errors='coerce').fillna(0).astype(int)

    # íŒŒìƒ ë³€ìˆ˜
    df['ì´í•©'] = df['ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜'] + df['í•˜ì°¨ì´ìŠ¹ê°ìˆ˜']

    return df

# ë¡œë“œ
try:
    df = load_data(uploaded, use_default)
except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
    st.stop()

if df is None:
    st.warning("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê¸°ë³¸ íŒŒì¼ ì‚¬ìš©ì„ ì²´í¬í•˜ì„¸ìš”.")
    st.stop()

# ë‚ ì§œ ì„ íƒ: 2025-10-01 ~ 2025-10-31
min_date = date(2025,10,1)
max_date = date(2025,10,31)
selected_date = st.date_input("ë‚ ì§œ ì„ íƒ (2025ë…„ 10ì›” ì¤‘ í•˜ë£¨)", value=min_date, min_value=min_date, max_value=max_date)

# ë…¸ì„  ì„ íƒ
lines = sorted(df['ë…¸ì„ ëª…'].unique().tolist())
selected_line = st.selectbox("í˜¸ì„  ì„ íƒ", options=['ì „ì²´'] + lines)

# í•„í„°ë§
mask_date = df['ì‚¬ìš©ì¼ì_dt'].dt.date == selected_date
filtered = df[mask_date]
if selected_line != 'ì „ì²´':
    filtered = filtered[filtered['ë…¸ì„ ëª…'] == selected_line]

if filtered.empty:
    st.warning("ì„ íƒ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    st.stop()

# ì—­ë³„ í•©ê³„ ì§‘ê³„
agg = filtered.groupby(['ë…¸ì„ ëª…','ì—­ëª…'], as_index=False).agg({
    'ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜': 'sum',
    'í•˜ì°¨ì´ìŠ¹ê°ìˆ˜': 'sum',
    'ì´í•©': 'sum'
})

top10 = agg.sort_values('ì´í•©', ascending=False).head(10).reset_index(drop=True)

# ìƒ‰ìƒ êµ¬ì„±: 1ë“± ë˜¥ìƒ‰(ê°ˆìƒ‰), ë‚˜ë¨¸ì§€ 9ê°œëŠ” í•‘í¬ ê·¸ë¼ë°ì´ì…˜
def make_pink_gradient(n, start_hex='#ff4da6', end_hex='#ffd6ea'):
    # n >=1
    def hex_to_rgb(h):
        h = h.lstrip('#')
        return tuple(int(h[i:i+2], 16) for i in (0, 2, 4))
    def rgb_to_hex(r,g,b):
        return f"#{r:02x}{g:02x}{b:02x}"
    s = hex_to_rgb(start_hex)
    e = hex_to_rgb(end_hex)
    colors = []
    if n == 1:
        colors.append(start_hex)
    else:
        for i in range(n):
            t = i / (n-1)
            rgb = (int(s[0] + (e[0]-s[0])*t), int(s[1] + (e[1]-s[1])*t), int(s[2] + (e[2]-s[2])*t))
            colors.append(rgb_to_hex(*rgb))
    return colors

brown = '#8B5A2B'  # ë˜¥ìƒ‰ ê³„ì—´ (ê°ˆìƒ‰)
pink_grad = make_pink_gradient(max(1, len(top10)-1))
colors = [brown] + pink_grad

# Plotly ë§‰ëŒ€ê·¸ë˜í”„ (ê°€ë¡œë°”, 1ë“± ìœ„)
# ì •ë ¬: í° ê°’ì´ ìœ„ì— ì˜¤ë„ë¡ ì—­ëª… ìˆœì„œë¥¼ ë’¤ì§‘ì–´ ì¶œë ¥
top10_plot = top10.copy()
# For horizontal bar with highest on top, reverse the DataFrame
top10_plot = top10_plot.iloc[::-1]
# assign colors in same reversed order so top item uses brown
colors_for_plot = colors[::-1]

fig = go.Figure()
fig.add_trace(go.Bar(
    x=top10_plot['ì´í•©'],
    y=top10_plot['ì—­ëª…'],
    orientation='h',
    text=top10_plot['ì´í•©'],
    textposition='auto',
    marker=dict(color=colors_for_plot),
    hovertemplate='<b>%{y}</b><br>ìŠ¹ì°¨: %{customdata[0]}<br>í•˜ì°¨: %{customdata[1]}<br>ì´í•©: %{x}<extra></extra>',
    customdata=top10_plot[['ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜','í•˜ì°¨ì´ìŠ¹ê°ìˆ˜']].values
))

fig.update_layout(
    title_text=f"{selected_date} - {selected_line} TOP10 (ìŠ¹ì°¨+í•˜ì°¨ í•©)",
    xaxis_title='ìŠ¹ê° ìˆ˜',
    yaxis_title='',
    template='plotly_white',
    height=600
)

# ì¶œë ¥
st.plotly_chart(fig, use_container_width=True)

with st.expander('ìƒì„¸ ë°ì´í„° (TOP10)'):
    st.dataframe(top10[['ë…¸ì„ ëª…','ì—­ëª…','ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜','í•˜ì°¨ì´ìŠ¹ê°ìˆ˜','ì´í•©']].reset_index(drop=True))

st.markdown("---")
st.caption('â€» ìƒ‰ìƒ: 1ë“±ì€ ë˜¥ìƒ‰(ê°ˆìƒ‰), ë‚˜ë¨¸ì§€ëŠ” í•‘í¬ ê³„ì—´ì˜ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.')

# ë‹¤ìš´ë¡œë“œ: top10 CSV
@st.cache_data
def to_csv(df):
    return df.to_csv(index=False).encode('utf-8-sig')

csv = to_csv(top10[['ë…¸ì„ ëª…','ì—­ëª…','ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜','í•˜ì°¨ì´ìŠ¹ê°ìˆ˜','ì´í•©']])
st.download_button('TOP10 CSV ë‹¤ìš´ë¡œë“œ', data=csv, file_name=f'top10_{selected_date}.csv', mime='text/csv')

# ë
